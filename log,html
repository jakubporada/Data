import { Component, OnInit } from '@angular/core';
import { FormBuilder, FormGroup, Validators } from '@angular/forms';
import { Router } from '@angular/router';

@Component({
  selector: 'app-login',
  templateUrl: './login.component.html',
  styleUrls: ['./login.component.css']
})
export class LoginComponent implements OnInit {
  loginForm: FormGroup;
  isLoading = false;
  showPassword = false;
  errorMessage = '';
  successMessage = '';

  constructor(
    private formBuilder: FormBuilder,
    private router: Router
    // Add your authentication service here
  ) {
    this.loginForm = this.formBuilder.group({
      email: ['', [Validators.required, Validators.email]],
      password: ['', [Validators.required, Validators.minLength(8)]],
      rememberMe: [false]
    });
  }

  ngOnInit(): void {
    // Initialize any needed services or check if user is already logged in
    this.initializeFloatingShapes();
  }

  // Form getters for easy access in template
  get email() { return this.loginForm.get('email'); }
  get password() { return this.loginForm.get('password'); }

  // Toggle password visibility
  togglePasswordVisibility(): void {
    this.showPassword = !this.showPassword;
  }

  // Handle form submission
  async onSubmit(): Promise<void> {
    if (this.loginForm.valid && !this.isLoading) {
      this.isLoading = true;
      this.errorMessage = '';
      this.successMessage = '';

      try {
        const credentials = {
          email: this.email?.value,
          password: this.password?.value,
          rememberMe: this.loginForm.get('rememberMe')?.value
        };

        // Replace this with your actual authentication service call
        const result = await this.authenticateUser(credentials);

        if (result.success) {
          this.successMessage = 'Login successful! Redirecting...';
          
          // Store auth token if needed
          if (credentials.rememberMe) {
            localStorage.setItem('rememberMe', 'true');
          }

          // Navigate to dashboard or intended route
          setTimeout(() => {
            this.router.navigate(['/dashboard']);
          }, 1500);
        } else {
          this.errorMessage = result.message || 'Invalid credentials. Please try again.';
        }
      } catch (error) {
        this.errorMessage = 'An error occurred during login. Please try again.';
        console.error('Login error:', error);
      } finally {
        this.isLoading = false;
      }
    } else {
      this.markFormGroupTouched();
    }
  }

  // Handle SSO login methods
  loginWithMicrosoft(): void {
    // Implement Microsoft SSO login
    console.log('Microsoft SSO login triggered');
    // Add your Microsoft authentication logic here
  }

  loginWithCAC(): void {
    // Implement CAC/PIV card login
    console.log('CAC/PIV login triggered');
    // Add your CAC authentication logic here
  }

  // Handle forgot password
  onForgotPassword(): void {
    // Navigate to forgot password page or open modal
    this.router.navigate(['/forgot-password']);
  }

  // Utility method to mark all form fields as touched
  private markFormGroupTouched(): void {
    Object.keys(this.loginForm.controls).forEach(key => {
      const control = this.loginForm.get(key);
      control?.markAsTouched();
    });
  }

  // Mock authentication method - replace with your actual service
  private async authenticateUser(credentials: any): Promise<{success: boolean, message?: string}> {
    // Simulate API call delay
    await new Promise(resolve => setTimeout(resolve, 2000));

    // Mock authentication logic - replace with actual API call
    if (credentials.email === 'admin@mantech.com' && credentials.password === 'password123') {
      return { success: true };
    } else {
      return { 
        success: false, 
        message: 'Invalid email or password. Please check your credentials and try again.' 
      };
    }
  }

  // Initialize floating background shapes animation
  private initializeFloatingShapes(): void {
    // This could be enhanced with more complex animations
    // For now, the CSS handles the basic floating animation
  }

  // Get error message for specific field
  getFieldError(fieldName: string): string {
    const field = this.loginForm.get(fieldName);
    
    if (field?.errors && field.touched) {
      if (field.errors['required']) {
        return `${this.capitalizeFirst(fieldName)} is required`;
      }
      if (field.errors['email']) {
        return 'Please enter a valid email address';
      }
      if (field.errors['minlength']) {
        return `${this.capitalizeFirst(fieldName)} must be at least ${field.errors['minlength'].requiredLength} characters`;
      }
    }
    
    return '';
  }

  // Utility method to capitalize first letter
  private capitalizeFirst(str: string): string {
    return str.charAt(0).toUpperCase() + str.slice(1);
  }

  // Handle enter key press
  onEnterKey(event: KeyboardEvent): void {
    if (event.key === 'Enter') {
      this.onSubmit();
    }
  }

  // Clear error message when user starts typing
  onInputChange(): void {
    if (this.errorMessage) {
      this.errorMessage = '';
    }
  }
}
